---
# ansible-playbook -i ./hosts rprj.yml

- hosts: all
  become: yes
  become_user: root

  tasks:
  #- debug: var=ansible_facts
  - name: Upgrade System
    apt:
      update_cache: yes
      upgrade: yes
      autoclean: yes
      autoremove: yes
    notify:
    - Restart Server

  handlers:
  - name: Restart Server
    become: yes
    become_user: root
    command: shutdown -r now


- hosts: R-Prj
  become: yes
  become_user: root
  vars:
    git_dir: /opt/rprj
    www_dir: /var/www/rprj
    mysql_password: mysecretpass
    dbpkg: mariadb-server
    #dbpkg: mysql-server

  tasks:

  #- name: Debug restart
     #command: /bin/true
     #notify: Start CBFox

  - name: Install Packages
    apt:
      name:
      - "{{ dbpkg }}"
      - php
      - php-mysql
      # for ansible
      - python-pymysql
      - python-selinux

  - name: Enable Apache Modules
    apache2_module:
      state: present
      name: ssl

  - name: Ensure mysql is running
    service:
      name: mysql
      state: started

  - name: Ensure apache2 is running
    service:
      name: apache2
      state: started

  #- name: Set Root Password
    #command:
      ##cmd: mysql -u root -e "show databases"
      #cmd: "mysql -u root -e \"update user set authentication_string=PASSWORD(\\\"{{ mysql_password }}\\\") where User='root';\" mysql"

  #- name: Create DB
    #become: yes
    #become_user: mysql
    #mysql_db:
      ##login_host: ""
      #login_user: root
      #login_password: "{{ mysql_password }}"
      #name: rproject
      #state: present

  #- name: Create DB
    #command:
      ##cmd: mysql -u root -e "show databases"
      #cmd: mysql -u root -e "create database if not exists rproject"

  - name: GIT clone and update
    git:
      repo: https://git.code.sf.net/p/r-prj/gitcode
      dest: "{{ git_dir }}"
      version: master
    register: git_updated
  - debug: "msg={{ git_updated.changed }}"

  - name: Remove default site
    file:
      path: /etc/apache2/sites-enabled/000-default.conf
      state: absent

  - name: Copy apache config if git changed
    copy:
      src: templates/rprj.conf
      dest: /etc/apache2/sites-available/rprj.conf
    when: git_updated.changed

  - name: Copy apache SSL config if git changed
    copy:
      src: templates/ssl_rprj.conf
      dest: /etc/apache2/sites-available/ssl_rprj.conf
    when: git_updated.changed

  - name: Link default default site
    file:
      src: /etc/apache2/sites-available/rprj.conf
      dest: /etc/apache2/sites-enabled/rprj.conf
      state: link
    when: git_updated.changed
    notify: Restart Apache Service

  - name: Link default default SSL site
    file:
      src: /etc/apache2/sites-available/ssl_rprj.conf
      dest: /etc/apache2/sites-enabled/ssl_rprj.conf
      state: link
    when: git_updated.changed
    notify: Restart Apache Service

  - name: Create a directory if it does not exist
    file:
      path: "{{ www_dir }}"
      state: directory
      mode: '0755'

  - name: Copy the PHP sources
    command:
      cmd: "cp -R {{ git_dir }}/php/ {{ www_dir }}/"
    #when: git_updated.changed

  - name: Restart Apache Service if git changed
    service:
      name: apache2
      state: restarted
    when: git_updated.changed

  handlers:

  - name: Restart Apache Service
    service:
      name: apache2
      state: restarted
